<h1 id="handling-root-announcements">Handling Root Announcements</h1>

<p>When a node receives a root announcement from a direct peer, it should do the following:</p>

<ol>
  <li>Perform sanity checks on the update;</li>
  <li>Store the received update against the peer in memory;</li>
  <li>Decide whether to re-parent;</li>
</ol>

<p>If a root announcement is received from any peer during the 1 second reparent wait interval, it should be sanity-checked (step 1) and stored (step 2) but should not be processed any further. This is to ensure that many updates arriving quickly from direct peers will not result in a flood of root announcements being sent from the node in rapid succession, which overall reduces the load on the network and prevents the tree rebuilding excessively.</p>

<h2 id="sanity-checks">Sanity checks</h2>

<p>The following sanity checks must be performed on all incoming root announcement updates:</p>

<ol>
  <li>The update must be well-formed, with no missing fields or unexpected values;</li>
  <li>There must be at least one signature;</li>
  <li>The first <strong>Signing public key</strong> must match the <strong>Root public key</strong>;</li>
  <li>The last <strong>Signing public key</strong> must match the public key of your direct peer;</li>
  <li>None of the signature entries should have a <strong>Destination port number</strong> of 0;</li>
  <li>The update must not contain any loops, that is that the update must not contain the same public key in the signatures more than once;</li>
  <li>If a root update has been received from this peer before, and the <strong>Root public key</strong> is equal to the last update, the <strong>Root sequence</strong> must be greater than or equal to the last update.</li>
</ol>

<p>If any of these conditions fail, the update is considered to be invalid, the update should be dropped and the peer that sent us this announcement should be disconnected as a result of the error.</p>

<h2 id="deciding-to-re-parent">Deciding to re-parent</h2>

<p>Once the sanity checks have passed, if the update came from the currently selected parent, perform the following checks in order:</p>

<ol>
  <li>If the reparent wait timer is active, do nothing and stop processing;</li>
  <li>If any of the <strong>Signatures</strong> entries in the update contain the node’s own public key, implying that our parent has suddenly decided to choose us as their parent instead:
    <ol>
      <li>Become a root node, sending an announcement to all of your direct peers notifying them of this fact;</li>
      <li>Start a 1 second reparent wait timer, after which the parent selection algorithm will run;</li>
    </ol>
  </li>
  <li>If the <strong>Root public key</strong> is lower than the last root announcement from our chosen parent, implying that either the previous root node has disappeared or the parent is notifying us of bad news:
    <ol>
      <li>Become a root node, sending an announcement to all of your direct peers notifying them of this fact;</li>
      <li>Start a 1 second reparent wait timer, after which the parent selection algorithm will run;</li>
    </ol>
  </li>
  <li>If the <strong>Root public key</strong> and the <strong>Root sequence</strong> fields are both equal to those in the last root announcement from our chosen parent, implying that the parent is notifying us of bad news:
    <ol>
      <li>Become a root node, sending an announcement to all of your direct peers notifying them of this fact;</li>
      <li>Start a 1 second reparent wait timer, after which the parent selection algorithm will run;</li>
    </ol>
  </li>
  <li>If the <strong>Root public key</strong> is higher than the last root announcement from our chosen parent, implying that our parent has learned about a stronger root:
    <ol>
      <li>Send a tree announcement with the new update to all directly connected peers;</li>
    </ol>
  </li>
  <li>If the <strong>Root public key</strong> is equal to the last root announcement but the <strong>Root sequence</strong> is higher than the last root announcement:
    <ol>
      <li>Send a tree announcement with the new update to all directly connected peers;</li>
    </ol>
  </li>
</ol>

<p>Otherwise, if the update arrived from another peer that is not our chosen parent, perform the following checks in order:</p>

<ol>
  <li>If the reparent wait timer is active, do nothing and stop processing;</li>
  <li>If any of the <strong>Signatures</strong> entries in the update contain the node’s own public key, implying that the peer has chosen us a parent, do nothing and stop processing;</li>
  <li>If the <strong>Root public key</strong> is higher than the last root announcement from our chosen parent:
    <ol>
      <li>Set the node’s chosen parent to this specific peer;</li>
      <li>Send a tree announcement with the new update to all directly connected peers;</li>
    </ol>
  </li>
  <li>If the <strong>Root public key</strong> is lower than the last root announcement from our chosen parent:
    <ol>
      <li>Send a tree announcement back to this peer only with the last root announcement from our chosen parent;</li>
    </ol>
  </li>
  <li>In any other case not matched by the above:
    <ol>
      <li>Run the parent selection algorithm.</li>
    </ol>
  </li>
</ol>
