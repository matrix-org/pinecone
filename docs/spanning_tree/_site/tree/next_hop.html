<h1 id="next-hop-calculation">Next Hop Calculation</h1>

<p>When using tree routing to route towards a certain set of coordinates, a simple distance formula is used. To calculate the distance between coordinates A and B:</p>

<ol>
  <li>Calculate the length of the common prefix of both sets of coordinates;</li>
  <li>Add the length of coordinates A to the length of coordinates B;</li>
  <li>Subtract the length of the common prefix multiplied by 2.</li>
</ol>

<p>As an illustrative example, where A is <code class="language-plaintext highlighter-rouge">[1 3 5 3 4]</code> and B is <code class="language-plaintext highlighter-rouge">[1 3 5 7 6 1]</code>:</p>

<ol>
  <li>Both A and B start with <code class="language-plaintext highlighter-rouge">[1 3 5]</code>, therefore the common prefix length is 3;</li>
  <li>A has a length of 5, B has a length of 6;</li>
  <li>(5 ＋ 6) － (3 ✕ 2) results in a total distance of 5 between A and B.</li>
</ol>

<p>The next-hop selection for tree routing is as follows:</p>

<ol>
  <li>Start with the distance from our own coordinates to the destination coordinates as the <span style="text-decoration:underline;">best distance</span>, and the <span style="text-decoration:underline;">best candidate</span> as an empty field;</li>
  <li>If the best distance is already 0 then the frame has arrived at its intended destination coordinates. Pass the frame to the local router and stop here, otherwise;</li>
  <li>Iterate through all directly connected peers, checking the following conditions in order:
    <ol>
      <li>Skip the peer and move onto the next if:
        <ol>
          <li>The peer has not sent us a root announcement yet;</li>
          <li>The peer is the peer that sent us the frame that we are trying to forward (we will never route the frame back to where it came from as this would create a routing loop);</li>
          <li>The <strong>Root public key</strong> of the peer’s last root announcement does not match that of our chosen parent’s last announcement;</li>
          <li>The <strong>Root sequence</strong> of the peer’s last root announcement does not match that of our chosen parent’s last announcement;</li>
        </ol>
      </li>
      <li>Calculate the distance from the peer’s coordinates to the destination coordinates;</li>
      <li>If the calculated distance is less than the best distance, update the best distance and mark the peer as the best candidate;</li>
      <li>Skip the peer and move onto the next if the calculated distance is greater than the best distance;</li>
      <li>If the best candidate is not empty and the peer’s last root announcement was received sooner than that of the best candidate, mark the peer as the best candidate.</li>
    </ol>
  </li>
</ol>

<p>If the best candidate is still empty at the end of the algorithm, there is no suitable next-hop candidate that will take the frame closer to its destination. A node must never route a tree-routed packet to a peer that will take it further away from the destination.</p>
